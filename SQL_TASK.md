# SQL Task -- Retrieve Last Quote per `document_id` (MySQL)

## Overview

This document provides the SQL solution to obtain the **latest quote per
`document_id`** for a list of 500 IDs in MySQL 8+, including indexing
guidance.

The solution uses:

-   A temporary table to handle 500 IDs efficiently
-   A window function (`ROW_NUMBER()`)
-   A composite index to optimize filtering and ordering

------------------------------------------------------------------------

## Recommended Index (Run Once)

``` sql
CREATE INDEX ix_quotes_doc_created_id
ON quotes (document_id, created_at, id);
```

### Why this index?

-   Supports filtering by `document_id`
-   Supports ordering by `created_at DESC, id DESC`
-   Enables efficient reverse index scans in MySQL 8+
-   Avoids full table scans when dataset is large

------------------------------------------------------------------------

## Complete Script

``` sql
-- Drop temp table if exists
DROP TEMPORARY TABLE IF EXISTS tmp_document_ids;

-- Create temp table
CREATE TEMPORARY TABLE tmp_document_ids (
    document_id VARCHAR(64) NOT NULL,
    PRIMARY KEY (document_id)
) ENGINE=MEMORY;

-- Insert 500 document IDs
INSERT INTO tmp_document_ids (document_id) VALUES
('doc1'),
('doc2'),
('doc3'),
('doc4'),
('doc5'),
('doc6'),
('doc7'),
('doc8'),
('doc9'),
('doc10'),
('doc11'),
('doc12'),
('doc13'),
('doc14'),
('doc15'),
('doc16'),
('doc17'),
('doc18'),
('doc19'),
('doc20'),
('doc21'),
('doc22'),
('doc23'),
('doc24'),
('doc25'),
('doc26'),
('doc27'),
('doc28'),
('doc29'),
('doc30'),
('doc31'),
('doc32'),
('doc33'),
('doc34'),
('doc35'),
('doc36'),
('doc37'),
('doc38'),
('doc39'),
('doc40'),
('doc41'),
('doc42'),
('doc43'),
('doc44'),
('doc45'),
('doc46'),
('doc47'),
('doc48'),
('doc49'),
('doc50'),
('doc51'),
('doc52'),
('doc53'),
('doc54'),
('doc55'),
('doc56'),
('doc57'),
('doc58'),
('doc59'),
('doc60'),
('doc61'),
('doc62'),
('doc63'),
('doc64'),
('doc65'),
('doc66'),
('doc67'),
('doc68'),
('doc69'),
('doc70'),
('doc71'),
('doc72'),
('doc73'),
('doc74'),
('doc75'),
('doc76'),
('doc77'),
('doc78'),
('doc79'),
('doc80'),
('doc81'),
('doc82'),
('doc83'),
('doc84'),
('doc85'),
('doc86'),
('doc87'),
('doc88'),
('doc89'),
('doc90'),
('doc91'),
('doc92'),
('doc93'),
('doc94'),
('doc95'),
('doc96'),
('doc97'),
('doc98'),
('doc99'),
('doc100'),
('doc101'),
('doc102'),
('doc103'),
('doc104'),
('doc105'),
('doc106'),
('doc107'),
('doc108'),
('doc109'),
('doc110'),
('doc111'),
('doc112'),
('doc113'),
('doc114'),
('doc115'),
('doc116'),
('doc117'),
('doc118'),
('doc119'),
('doc120'),
('doc121'),
('doc122'),
('doc123'),
('doc124'),
('doc125'),
('doc126'),
('doc127'),
('doc128'),
('doc129'),
('doc130'),
('doc131'),
('doc132'),
('doc133'),
('doc134'),
('doc135'),
('doc136'),
('doc137'),
('doc138'),
('doc139'),
('doc140'),
('doc141'),
('doc142'),
('doc143'),
('doc144'),
('doc145'),
('doc146'),
('doc147'),
('doc148'),
('doc149'),
('doc150'),
('doc151'),
('doc152'),
('doc153'),
('doc154'),
('doc155'),
('doc156'),
('doc157'),
('doc158'),
('doc159'),
('doc160'),
('doc161'),
('doc162'),
('doc163'),
('doc164'),
('doc165'),
('doc166'),
('doc167'),
('doc168'),
('doc169'),
('doc170'),
('doc171'),
('doc172'),
('doc173'),
('doc174'),
('doc175'),
('doc176'),
('doc177'),
('doc178'),
('doc179'),
('doc180'),
('doc181'),
('doc182'),
('doc183'),
('doc184'),
('doc185'),
('doc186'),
('doc187'),
('doc188'),
('doc189'),
('doc190'),
('doc191'),
('doc192'),
('doc193'),
('doc194'),
('doc195'),
('doc196'),
('doc197'),
('doc198'),
('doc199'),
('doc200'),
('doc201'),
('doc202'),
('doc203'),
('doc204'),
('doc205'),
('doc206'),
('doc207'),
('doc208'),
('doc209'),
('doc210'),
('doc211'),
('doc212'),
('doc213'),
('doc214'),
('doc215'),
('doc216'),
('doc217'),
('doc218'),
('doc219'),
('doc220'),
('doc221'),
('doc222'),
('doc223'),
('doc224'),
('doc225'),
('doc226'),
('doc227'),
('doc228'),
('doc229'),
('doc230'),
('doc231'),
('doc232'),
('doc233'),
('doc234'),
('doc235'),
('doc236'),
('doc237'),
('doc238'),
('doc239'),
('doc240'),
('doc241'),
('doc242'),
('doc243'),
('doc244'),
('doc245'),
('doc246'),
('doc247'),
('doc248'),
('doc249'),
('doc250'),
('doc251'),
('doc252'),
('doc253'),
('doc254'),
('doc255'),
('doc256'),
('doc257'),
('doc258'),
('doc259'),
('doc260'),
('doc261'),
('doc262'),
('doc263'),
('doc264'),
('doc265'),
('doc266'),
('doc267'),
('doc268'),
('doc269'),
('doc270'),
('doc271'),
('doc272'),
('doc273'),
('doc274'),
('doc275'),
('doc276'),
('doc277'),
('doc278'),
('doc279'),
('doc280'),
('doc281'),
('doc282'),
('doc283'),
('doc284'),
('doc285'),
('doc286'),
('doc287'),
('doc288'),
('doc289'),
('doc290'),
('doc291'),
('doc292'),
('doc293'),
('doc294'),
('doc295'),
('doc296'),
('doc297'),
('doc298'),
('doc299'),
('doc300'),
('doc301'),
('doc302'),
('doc303'),
('doc304'),
('doc305'),
('doc306'),
('doc307'),
('doc308'),
('doc309'),
('doc310'),
('doc311'),
('doc312'),
('doc313'),
('doc314'),
('doc315'),
('doc316'),
('doc317'),
('doc318'),
('doc319'),
('doc320'),
('doc321'),
('doc322'),
('doc323'),
('doc324'),
('doc325'),
('doc326'),
('doc327'),
('doc328'),
('doc329'),
('doc330'),
('doc331'),
('doc332'),
('doc333'),
('doc334'),
('doc335'),
('doc336'),
('doc337'),
('doc338'),
('doc339'),
('doc340'),
('doc341'),
('doc342'),
('doc343'),
('doc344'),
('doc345'),
('doc346'),
('doc347'),
('doc348'),
('doc349'),
('doc350'),
('doc351'),
('doc352'),
('doc353'),
('doc354'),
('doc355'),
('doc356'),
('doc357'),
('doc358'),
('doc359'),
('doc360'),
('doc361'),
('doc362'),
('doc363'),
('doc364'),
('doc365'),
('doc366'),
('doc367'),
('doc368'),
('doc369'),
('doc370'),
('doc371'),
('doc372'),
('doc373'),
('doc374'),
('doc375'),
('doc376'),
('doc377'),
('doc378'),
('doc379'),
('doc380'),
('doc381'),
('doc382'),
('doc383'),
('doc384'),
('doc385'),
('doc386'),
('doc387'),
('doc388'),
('doc389'),
('doc390'),
('doc391'),
('doc392'),
('doc393'),
('doc394'),
('doc395'),
('doc396'),
('doc397'),
('doc398'),
('doc399'),
('doc400'),
('doc401'),
('doc402'),
('doc403'),
('doc404'),
('doc405'),
('doc406'),
('doc407'),
('doc408'),
('doc409'),
('doc410'),
('doc411'),
('doc412'),
('doc413'),
('doc414'),
('doc415'),
('doc416'),
('doc417'),
('doc418'),
('doc419'),
('doc420'),
('doc421'),
('doc422'),
('doc423'),
('doc424'),
('doc425'),
('doc426'),
('doc427'),
('doc428'),
('doc429'),
('doc430'),
('doc431'),
('doc432'),
('doc433'),
('doc434'),
('doc435'),
('doc436'),
('doc437'),
('doc438'),
('doc439'),
('doc440'),
('doc441'),
('doc442'),
('doc443'),
('doc444'),
('doc445'),
('doc446'),
('doc447'),
('doc448'),
('doc449'),
('doc450'),
('doc451'),
('doc452'),
('doc453'),
('doc454'),
('doc455'),
('doc456'),
('doc457'),
('doc458'),
('doc459'),
('doc460'),
('doc461'),
('doc462'),
('doc463'),
('doc464'),
('doc465'),
('doc466'),
('doc467'),
('doc468'),
('doc469'),
('doc470'),
('doc471'),
('doc472'),
('doc473'),
('doc474'),
('doc475'),
('doc476'),
('doc477'),
('doc478'),
('doc479'),
('doc480'),
('doc481'),
('doc482'),
('doc483'),
('doc484'),
('doc485'),
('doc486'),
('doc487'),
('doc488'),
('doc489'),
('doc490'),
('doc491'),
('doc492'),
('doc493'),
('doc494'),
('doc495'),
('doc496'),
('doc497'),
('doc498'),
('doc499'),
('doc500');

-- Retrieve latest quote per document_id
WITH ranked AS (
    SELECT
        q.*,
        ROW_NUMBER() OVER (
            PARTITION BY q.document_id
            ORDER BY q.created_at DESC, q.id DESC
        ) AS rn
    FROM quotes q
    INNER JOIN tmp_document_ids t
        ON t.document_id = q.document_id
)
SELECT
    ranked.id,
    ranked.document_id,
    ranked.created_at
FROM ranked
WHERE ranked.rn = 1
ORDER BY ranked.document_id;

-- Cleanup
DROP TEMPORARY TABLE IF EXISTS tmp_document_ids;
```

------------------------------------------------------------------------

## Notes

-   Requires MySQL 8+ (window functions).
-   Avoid `SELECT *` in large production tables.
-   Temporary table approach is preferred over large `IN (...)` lists.
-   Tie-breaking is handled using `id DESC` when timestamps are equal.
