trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - "*"

variables:
  vmImage: "ubuntu-latest"
  javaVersion: "21"
  mavenCache: "$(Pipeline.Workspace)/.m2/repository"
  imageName: "suratech"
  imageTag: "$(Build.BuildId)"
  fullImageName: "$(imageName):$(imageTag)"

stages:
  - stage: Build
    displayName: "Build (Maven)"
    jobs:
      - job: MavenBuild
        displayName: "Compile + Package"
        pool:
          vmImage: "$(vmImage)"
        steps:
          - task: Cache@2
            displayName: "Cache Maven local repo"
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
              path: "$(mavenCache)"

          - task: JavaToolInstaller@0
            displayName: "Use Java $(javaVersion)"
            inputs:
              versionSpec: "$(javaVersion)"
              jdkArchitectureOption: "x64"
              jdkSourceOption: "PreInstalled"

          - task: Maven@4
            displayName: "Maven package (skip tests)"
            inputs:
              mavenPomFile: "pom.xml"
              goals: "clean package"
              options: "-DskipTests"
              publishJUnitResults: false

          - publish: "$(System.DefaultWorkingDirectory)/target"
            displayName: "Publish JAR artifact (target/)"
            artifact: "target"

  - stage: Test
    displayName: "Test (Unit)"
    dependsOn: Build
    jobs:
      - job: UnitTests
        displayName: "Run unit tests"
        pool:
          vmImage: "$(vmImage)"
        steps:
          - task: Cache@2
            displayName: "Cache Maven local repo"
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
              path: "$(mavenCache)"

          - task: JavaToolInstaller@0
            displayName: "Use Java $(javaVersion)"
            inputs:
              versionSpec: "$(javaVersion)"
              jdkArchitectureOption: "x64"
              jdkSourceOption: "PreInstalled"

          - task: Maven@4
            displayName: "Maven test"
            inputs:
              mavenPomFile: "pom.xml"
              goals: "test"
              options: "-Dmaven.repo.local=$(mavenCache)"
              publishJUnitResults: true
              testResultsFiles: "**/surefire-reports/TEST-*.xml"

          - task: PublishCodeCoverageResults@2
            displayName: "Publish code coverage (si aplica)"
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: "JaCoCo"
              summaryFileLocation: "$(System.DefaultWorkingDirectory)/**/target/site/jacoco/jacoco.xml"
              reportDirectory: "$(System.DefaultWorkingDirectory)/**/target/site/jacoco"
              failIfCoverageEmpty: false

  - stage: Container
    displayName: "Build Container (Docker)"
    dependsOn: Test
    jobs:
      - job: DockerBuild
        displayName: "Docker build"
        pool:
          vmImage: "$(vmImage)"
        steps:
          - task: Docker@2
            displayName: "Docker build"
            inputs:
              command: "build"
              Dockerfile: "Dockerfile"
              buildContext: "$(System.DefaultWorkingDirectory)"
              repository: "$(imageName)"
              tags: |
                $(imageTag)

          - script: |
              docker images | head -n 20
              echo "Built image: $(fullImageName)"
            displayName: "List images"

          - script: |
              docker save "$(fullImageName)" -o suratech-image.tar
            displayName: "docker save image"
          - publish: "suratech-image.tar"
            displayName: "Publish image tar artifact"
            artifact: "docker-image"

  - stage: IntegrationTest
    displayName: "Integration Test (docker-compose)"
    dependsOn: Container
    jobs:
      - job: IT
        displayName: "Bring up stack + smoke test"
        pool:
          vmImage: "$(vmImage)"
        steps:
          - download: current
            artifact: "docker-image"
            displayName: "Download image artifact"

          - script: |
              docker load -i "$(Pipeline.Workspace)/docker-image/suratech-image.tar"
              docker image ls | head -n 20
            displayName: "docker load image"

          - script: |
              set -e
              export APP_IMAGE="$(fullImageName)"
              docker compose version
              docker compose up -d --wait || docker compose up -d
              docker compose ps
            displayName: "docker compose up"

          - script: |
              set -e
              echo "Waiting for readiness..."
              for i in {1..60}; do
                if curl -fsS "http://localhost:8080/actuator/health/readiness" | grep -q '"status"'; then
                  echo "Ready"
                  break
                fi
                sleep 2
              done

              echo "Calling liveness..."
              curl -fsS "http://localhost:8080/actuator/health/liveness"

              echo "Calling root or a known endpoint..."
              # Ajusta el endpoint segÃºn tu API real
              curl -fsS "http://localhost:8080/actuator/health"
            displayName: "Integration smoke tests"

          - script: |
              docker compose logs --no-color > docker-compose.logs.txt || true
            displayName: "Collect compose logs"
            condition: always()

          - publish: "docker-compose.logs.txt"
            displayName: "Publish integration logs"
            artifact: "integration-logs"
            condition: always()

          - script: |
              docker compose down -v --remove-orphans || true
            displayName: "docker compose down"
            condition: always()