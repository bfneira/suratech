trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - "*"

variables:
  agentPool: "self-hosted"   # Nombre EXACTO del Agent Pool en Azure DevOps
  mavenCache: "$(Pipeline.Workspace)/.m2/repository"
  imageName: "suratech"
  imageTag: "$(Build.BuildId)"
  fullImageName: "$(imageName):$(imageTag)"

stages:
  - stage: BuildAndTest
    displayName: "Build + Test (Maven)"
    jobs:
      - job: Maven
        displayName: "Compile + Unit Tests + Package"
        pool:
          name: "$(agentPool)"
        steps:
          - script: |
              echo "Agent: $(Agent.Name)"
              echo "OS: $(Agent.OS)"
              echo "JAVA_HOME=%JAVA_HOME%"
              where java || exit /b 1
              java -version || exit /b 1
              where mvn || exit /b 1
              mvn -version || exit /b 1
              docker --version || exit /b 1
              docker compose version || exit /b 1
            displayName: "Verify tools (Java/Maven/Docker)"

          - task: Cache@2
            displayName: "Cache Maven local repo"
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
              path: "$(mavenCache)"

          - task: Maven@4
            displayName: "Maven clean test package"
            inputs:
              mavenPomFile: "pom.xml"
              goals: "clean test package"
              options: "-Dmaven.repo.local=$(mavenCache)"
              publishJUnitResults: true
              testResultsFiles: "**/surefire-reports/TEST-*.xml"

          - task: PublishCodeCoverageResults@2
            displayName: "Publish code coverage (si aplica)"
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: "JaCoCo"
              summaryFileLocation: "$(System.DefaultWorkingDirectory)/**/target/site/jacoco/jacoco.xml"
              reportDirectory: "$(System.DefaultWorkingDirectory)/**/target/site/jacoco"
              failIfCoverageEmpty: false

          - publish: "$(System.DefaultWorkingDirectory)/target"
            displayName: "Publish JAR artifact (target/)"
            artifact: "target"

  - stage: Container
    displayName: "Build Container (Docker)"
    dependsOn: BuildAndTest
    jobs:
      - job: DockerBuild
        displayName: "Docker build"
        pool:
          name: "$(agentPool)"
        steps:
          - task: Docker@2
            displayName: "Docker build"
            inputs:
              command: "build"
              Dockerfile: "Dockerfile"
              buildContext: "$(System.DefaultWorkingDirectory)"
              repository: "$(imageName)"
              tags: |
                $(imageTag)

          - script: |
              docker images | more
              echo Built image: $(fullImageName)
            displayName: "List images"

          - script: |
              docker save "$(fullImageName)" -o suratech-image.tar
            displayName: "docker save image"

          - publish: "suratech-image.tar"
            displayName: "Publish image tar artifact"
            artifact: "docker-image"

  - stage: IntegrationTest
    displayName: "Integration Test (docker-compose)"
    dependsOn: Container
    jobs:
      - job: IT
        displayName: "Bring up stack + smoke test"
        pool:
          name: "$(agentPool)"
        steps:
          - download: current
            artifact: "docker-image"
            displayName: "Download image artifact"

          - script: |
              docker load -i "$(Pipeline.Workspace)\docker-image\suratech-image.tar"
              docker image ls
            displayName: "docker load image"

          - script: |
              set APP_IMAGE=$(fullImageName)
              echo APP_IMAGE=%APP_IMAGE%
              docker compose version
              docker compose up -d
              docker compose ps
            displayName: "docker compose up"

          - script: |
              @echo off
              setlocal EnableExtensions EnableDelayedExpansion

              echo Waiting for readiness...
              set ready=0

              for /L %%i in (1,1,60) do (
                curl -fsS "http://localhost:8080/actuator/health/readiness" | findstr /C:"\"status\":\"UP\"" >nul
                if !errorlevel! == 0 (
                  echo Ready
                  set ready=1
                  goto :done
                )
                timeout /t 2 /nobreak >nul
              )

              :done
              if "%ready%"=="0" (
                echo ERROR: App never became ready
                docker compose ps
                docker compose logs --no-color
                exit /b 1
              )

              echo Calling liveness...
              curl -fsS "http://localhost:8080/actuator/health/liveness" | findstr /C:"\"status\":\"UP\"" >nul
              if errorlevel 1 exit /b 1

              echo Calling health...
              curl -fsS "http://localhost:8080/actuator/health" | findstr /C:"\"status\":\"UP\"" >nul
              if errorlevel 1 exit /b 1
            displayName: "Integration smoke tests"

          - script: |
              docker compose logs --no-color > docker-compose.logs.txt || exit /b 0
            displayName: "Collect compose logs"
            condition: always()

          - publish: "docker-compose.logs.txt"
            displayName: "Publish integration logs"
            artifact: "integration-logs"
            condition: always()

          - script: |
              docker compose down -v --remove-orphans || exit /b 0
            displayName: "docker compose down"
            condition: always()