trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - "*"

variables:
  agentPool: "self-hosted"
  mavenCache: "$(Pipeline.Workspace)/.m2/repository"
  imageName: "suratech"
  imageTag: "$(Build.BuildId)"
  fullImageName: "$(imageName):$(imageTag)"
  javaHome: "C:\\Program Files\\Java\\jdk-21"
  mavenHome: "C:\\maven\\apache-maven-3.9.12"

stages:
  - stage: BuildAndTest
    displayName: "Build + Test (Maven)"
    jobs:
      - job: Maven
        displayName: "Compile + Unit Tests + Package"
        pool:
          name: "$(agentPool)"
        steps:
          - script: |
              echo Agent: $(Agent.Name)
              echo OS: $(Agent.OS)

              set "JAVA_HOME=$(javaHome)"
              set "MAVEN_HOME=$(mavenHome)"
              set "PATH=%JAVA_HOME%\bin;%MAVEN_HOME%\bin;%PATH%"

              echo JAVA_HOME=%JAVA_HOME%
              echo MAVEN_HOME=%MAVEN_HOME%

              where java || exit /b 1
              java -version || exit /b 1

              where mvn || exit /b 1
              mvn -version || exit /b 1

              where docker || exit /b 1
              docker --version || exit /b 1
              docker compose version || exit /b 1
            displayName: "Verify tools (Java/Maven/Docker)"

          - task: Cache@2
            displayName: "Cache Maven local repo"
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
              path: "$(mavenCache)"

          - task: Maven@4
            displayName: "Maven clean test package"
            inputs:
              mavenPomFile: "pom.xml"
              goals: "clean test package"
              options: "-B -Dmaven.repo.local=$(mavenCache) -Dtest=!SuratechApplicationTests"
              publishJUnitResults: true
              testResultsFiles: "**/surefire-reports/TEST-*.xml"
              javaHomeOption: "Path"
              jdkDirectory: "$(javaHome)"
              mavenVersionOption: "Path"
              mavenDirectory: "$(mavenHome)"

          - task: PublishCodeCoverageResults@2
            displayName: "Publish code coverage (si aplica)"
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: "JaCoCo"
              summaryFileLocation: "$(System.DefaultWorkingDirectory)/**/target/site/jacoco/jacoco.xml"
              reportDirectory: "$(System.DefaultWorkingDirectory)/**/target/site/jacoco"
              failIfCoverageEmpty: false

          - publish: "$(System.DefaultWorkingDirectory)/target"
            displayName: "Publish JAR artifact (target/)"
            artifact: "target"

  - stage: Container
    displayName: "Build Container (Docker)"
    dependsOn: BuildAndTest
    jobs:
      - job: DockerBuild
        displayName: "Docker build"
        pool:
          name: "$(agentPool)"
        steps:
          - script: |
              echo Agent: $(Agent.Name)
              echo OS: $(Agent.OS)

              set "JAVA_HOME=$(javaHome)"
              set "MAVEN_HOME=$(mavenHome)"
              set "PATH=%JAVA_HOME%\bin;%MAVEN_HOME%\bin;%PATH%"

              where docker || exit /b 1
              docker --version || exit /b 1
            displayName: "Verify docker (self-hosted)"

          - task: Docker@2
            displayName: "Docker build"
            inputs:
              command: "build"
              Dockerfile: "Dockerfile"
              buildContext: "$(System.DefaultWorkingDirectory)"
              repository: "$(imageName)"
              tags: |
                $(imageTag)

          - script: |
              docker images | more
              echo Built image: $(fullImageName)
            displayName: "List images"

          - script: |
              docker save "$(fullImageName)" -o suratech-image.tar
            displayName: "docker save image"

          - publish: "suratech-image.tar"
            displayName: "Publish image tar artifact"
            artifact: "docker-image"

  - stage: IntegrationTest
    displayName: "Integration Test (docker-compose)"
    dependsOn: Container
    jobs:
      - job: IT
        displayName: "Bring up stack + smoke test"
        pool:
          name: "$(agentPool)"
        steps:
          - script: |
              echo Agent: $(Agent.Name)
              echo OS: $(Agent.OS)

              set "JAVA_HOME=$(javaHome)"
              set "MAVEN_HOME=$(mavenHome)"
              set "PATH=%JAVA_HOME%\bin;%MAVEN_HOME%\bin;%PATH%"

              where docker || exit /b 1
              docker --version || exit /b 1
              docker compose version || exit /b 1
            displayName: "Verify docker compose (self-hosted)"

          - download: current
            artifact: "docker-image"
            displayName: "Download image artifact"

          - script: |
              docker load -i "$(Pipeline.Workspace)\docker-image\suratech-image.tar"
              docker image ls
            displayName: "docker load image"

          - script: |
              set "APP_IMAGE=$(fullImageName)"
              echo APP_IMAGE=%APP_IMAGE%
              docker compose up -d
              docker compose ps
            displayName: "docker compose up"

          - powershell: |
              docker compose ps
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            displayName: "Debug: containers status & ports"

          - powershell: |
              Write-Host "Last 200 lines of compose logs:"
              docker compose logs --no-color --tail=200
            displayName: "Debug: compose logs (tail 200)"

          - powershell: |
              $ErrorActionPreference = "Stop"

              Write-Host "Waiting for readiness..."
              $ready = $false

              for ($i=1; $i -le 60; $i++) {
                try {
                  $resp = Invoke-RestMethod -Uri "http://localhost:8080/actuator/health/readiness" -TimeoutSec 2
                  if ($resp.status -eq "UP") {
                    Write-Host "Ready"
                    $ready = $true
                    break
                  }
                } catch {
                  Write-Host "Not ready yet ($i/60): $($_.Exception.Message)"
                }
                Start-Sleep -Seconds 2
              }

              if (-not $ready) {
                Write-Host "ERROR: App never became ready"
                docker compose ps | Out-String | Write-Host
                docker compose logs --no-color | Out-String | Write-Host
                throw "Readiness failed"
              }

              Write-Host "Calling liveness..."
              $live = Invoke-RestMethod -Uri "http://localhost:8080/actuator/health/liveness" -TimeoutSec 5
              if ($live.status -ne "UP") { throw "Liveness not UP" }

              Write-Host "Calling health..."
              $health = Invoke-RestMethod -Uri "http://localhost:8080/actuator/health" -TimeoutSec 5
              if ($health.status -ne "UP") { throw "Health not UP" }

              Write-Host "Smoke tests passed."
            displayName: "Integration smoke tests"

          - script: |
              docker compose logs --no-color > docker-compose.logs.txt || exit /b 0
            displayName: "Collect compose logs"
            condition: always()

          - publish: "docker-compose.logs.txt"
            displayName: "Publish integration logs"
            artifact: "integration-logs"
            condition: always()

          - script: |
              docker compose down -v --remove-orphans || exit /b 0
            displayName: "docker compose down"
            condition: always()